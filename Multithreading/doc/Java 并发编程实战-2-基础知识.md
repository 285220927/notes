# 线程安全性

共享：意味着变量可以由多个线程同时访问。

可变：以为变量的值在其生命周期内可以发生变化。

**如何避免线程不安全**

+ 不在线程间共享变量。
+ 将状态变量修改为不可变量。
+ 在访问状态变量时使用同步。

没有共享就没有伤害。

## 什么是线程安全性

正确性：某个类的行为与其规范完全一致。所见即所闻（we know it when we see it）。

线程安全性：当多个线程访问某个类时，这个类始终能表现出正确的行为，那么就称这个类是线程安全的。

```tex
当多个线程访问某个类时，不管运行时环境采用何种调度方式或者这些线程将如何交替执行，并且在主调代码中不需要任何额外的同步或协同，这个类都能表现出正确的行为，那么就称这个类是线程安全的。
```

因为线程安全类中封装了必要的同步机制，因此客户端无须进一步采用同步措施。例如 JUC 容器。

无状态对象一定是线程安全的。

无状态对象

```tex
它既不包含任何域，也不包含任何对其他类的中域的引用。 计算过程中的临时状态仅存在线程栈上的局部变量中，并且只能由正在执行的线程访问。访问。访问该类的线程不会影响另一个访问同一个类的线程的计算结果。
```

# 原子性

不可分割的。

要么完全不执行，要么全部执行完。

```tex
假定有两个操作 A 和 B，如果从执行 A 的线程来看，当另一个线程执行 B 时，要么将 B 全部执行完，要么完全不执行 B，那么 A 和 B 对彼此来说是原子的。原子操作是指，对于访问同一个状态的所有操作（包括该操作本身）来说，这个操作是一个以原子方式执行的操作。
```

## 竞态条件（Race Condition）

在并发编程中，这种由于不恰当的执行时序而出现不正确的结果。

当某个计算的正确性取决于多个线程的交替执行时序时，那么就会发生竞态条件。

最常见的竞态条件类型就是“先检查后执行（Check-Then-Act）”操作，即通过一个可能失效的观测结果来决定下一步的动作。

## 复合操作

i++算是复合操作，读取-修改-写入，是三个操作。

# 加锁机制

要保证状态的一致性，就需要在单个原子操作中更新所有相关的状态变量。

## 内置锁

每个 Java 对象都可以用做一个实现同步的锁，这些锁被称为内置锁（Intrinsic Lock）或者监视器锁（Monitor Lock）。线程在进入同步代码块之前会自动获得锁，并且在退出同步代码块时自动释放锁，而无论是通过正常的控制路径退出，还是通过代码块中抛出异常退出。获得内置锁的唯一途径就是进入由这个锁保护的同步代码块或方法。

```java
synchronized(lock){
	// 访问或修改由锁保护的共享状态
}
```

Java 的内置锁相当于一种互斥体（互斥锁），这意味着最多只有和一个线程能持有这种锁。当线程 A 尝试获取一个由线程 B 持有的锁时，线程 A 必须等待或者阻塞，直到线程 B 释放这个锁。如果 B 永远不释放锁，那么 A 也将永远地等下去。（可能发生死锁的情况）

## 重入

当某个线程请求一个由其他线程持有的锁时，发出请求的线程就会阻塞。然而，由于内置锁是可重入的，因此如果某个线程试图获得一个已经由它自己持有的锁，那么这个请求就会成功。“重入”意味着获取锁的操作粒度是“线程”，而不是“调用”。

重入的一种实现方法是，为每个锁关联一个获取计数值和一个所有者线程，当计数值为 0 时，这个锁就被认为是没有被任何线程持有，当线程请求一个未被持有的锁时，JVM将记下锁的持有者，并且将获取计数值置为1。如果同一个线程再次获取这个锁，计数值将递增，而当线程退出同步代码块时，计数器会相应地递减。当计数值为 0 时，这个锁将被释放。

# 用锁来保护状态

锁能使其保护的代码路径以串行形式来访问。

```tex
对于可能被多个线程同时访问的可变状态变量，在访问（读/写）它时都需要持有同一个锁，在这种情况下，我们称状态变量是由这个锁保护的。
```

每个共享的和可变的变量都应该只由一个锁来保护，从而使维护人员知道是哪一个锁。

Vector、HashTable 这种代码是粗粒度的锁应用的典型。即全部加上锁。并非所有的数据都需要锁的保护。

`对于每个包含多个变量的不变性条件，其中涉及的所有变量都需要由同一个锁来保护。`

# 活跃性与性能

精准控制锁的作用域，将需要锁来保护的区域包括进来，这才能发挥多线程的优势。

```tex
通常，在简单性与性能之间存在着相互制约因素。当实现某个同步策略时，一定不要盲目地为了性能而牺牲简单性（这可能破坏安全性）。
```

如果持有锁的时间过长，那么会带来活跃性或性能问题。

```tex
当执行时间较长的计算或者可能无法快速完成的操作时（例如网络 I/O 或控制台 I/O），一定不要持有锁。
```



